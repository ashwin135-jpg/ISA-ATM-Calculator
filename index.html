<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISA Master Tool</title>

  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
  <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

  <!-- Airport fuzzy search -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2"></script>

  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #050816; color: white; }
    header { text-align: center; padding: 40px 20px 20px; }
    header h1 { font-size: 2.5rem; margin-bottom: 10px; }
    header p { font-size: 1.2rem; color: #ccc; }

    .dashboard-section {
      padding: 40px 20px 60px;
      background: radial-gradient(circle at top, #050816 0, #020617 55%, #000000 100%);
      color: #e5ecff;
    }
    .dashboard-title {
      max-width: 1100px; margin: 0 auto 20px auto;
      display: flex; justify-content: space-between; align-items: center; gap: 10px;
    }
    .dashboard-title-main { font-size: 1.4rem; font-weight: 600; letter-spacing: 0.03em; }
    .dashboard-subtext { font-size: 0.9rem; color: #a6b4d9; }
    .tag-pill {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 4px 10px; border-radius: 999px;
      font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.09em;
      background: linear-gradient(135deg, rgba(34,211,238,0.18), rgba(129,140,248,0.25));
      color: #e0faff; border: 1px solid rgba(56,189,248,0.6);
      box-shadow: 0 0 16px rgba(45,212,191,0.5);
    }
    .dashboard-grid {
      max-width: 1100px; margin: 0 auto;
      display: grid; grid-template-columns: 1.2fr 1.8fr;
      grid-template-rows: auto auto; gap: 20px;
    }

    .dash-card {
      background: radial-gradient(circle at top left, #111827 0, #020617 75%);
      border-radius: 22px; padding: 18px 20px;
      box-shadow: 0 22px 50px rgba(0,0,0,0.75);
      border: 1px solid rgba(148,163,184,0.25);
      color: #e5ecff;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
    }
    .dash-card:hover { transform: translateY(-4px); box-shadow: 0 28px 70px rgba(15,23,42,0.95); border-color: rgba(56,189,248,0.6); }
    .dash-card h3 { margin-top: 0; margin-bottom: 8px; font-size: 1rem; font-weight: 600; letter-spacing: 0.06em; text-transform: uppercase; color: #f9fbff; }

    .dash-row { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
    .big-city { font-size: 1.4rem; font-weight: 600; color: #f9fafb; }
    .big-time { font-size: 2.7rem; font-weight: 700; color: #e5f3ff; }
    .date-line { font-size: 0.85rem; color: #9ca9c9; margin-top: 4px; }

    .metric-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: #9ca3ff; margin-bottom: 4px; }
    .metric-value { font-size: 1.2rem; font-weight: 600; color: #e0f2ff; }
    .metric-small { font-size: 0.85rem; color: #c0cbe9; }

    .divider-line { height: 1px; background: linear-gradient(to right, transparent, rgba(148,163,184,0.5), transparent); margin: 10px 0 12px; }
    .forecast-row { display: flex; justify-content: space-between; font-size: 0.8rem; color: #d2deef; margin: 3px 0; }

    .news-bullet { font-size: 0.82rem; margin: 3px 0; color: #d3e2ff; }
    .news-link { color: #7dd3fc; text-decoration: none; }
    .news-link:hover { text-decoration: underline; color: #a5b4fc; }

    .ai-search { margin-top: 12px; display: flex; gap: 8px; align-items: center; }
    .ai-input {
      flex: 1; padding: 8px 10px; border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
      color: #e5ecff; font-size: 0.85rem; outline: none;
      box-shadow: 0 0 0 1px rgba(15,23,42,0.7);
    }
    .ai-input::placeholder { color: #9ca3c7; }
    .ai-input:focus { border-color: rgba(56,189,248,0.9); box-shadow: 0 0 18px rgba(56,189,248,0.55); }
    .ai-button {
      padding: 8px 14px; border-radius: 999px; border: none;
      font-size: 0.85rem; font-weight: 600; cursor: pointer;
      background: linear-gradient(135deg, #22c55e, #22d3ee);
      color: #020617; box-shadow: 0 18px 35px rgba(34,197,94,0.45);
      white-space: nowrap;
    }
    .ai-button:hover { filter: brightness(1.08); box-shadow: 0 20px 45px rgba(34,197,94,0.7); }
    .ai-status { font-size: 0.78rem; color: #a5b4fc; margin-top: 6px; }
    .ai-answer-bubble {
      margin-top: 8px; padding: 10px 12px; border-radius: 16px;
      background: radial-gradient(circle at top left, #0ea5e9 0, #1e293b 55%);
      color: #ecfeff; font-size: 0.9rem; line-height: 1.4;
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.9);
      opacity: 0; transform: translateY(8px) scale(0.98);
      transition: opacity 0.25s ease-out, transform 0.25s ease-out;
    }
    .ai-answer-bubble.show { opacity: 1; transform: translateY(0) scale(1); }
    .hidden { display: none; }

    .airport-row { display: flex; gap: 8px; align-items: center; margin-top: 4px; position: relative; }
    .airport-input {
      flex: 1; padding: 8px 12px; border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.9);
      color: #e5ecff; font-size: 0.85rem; outline: none;
    }
    .airport-input:focus { border-color: rgba(56,189,248,0.9); box-shadow: 0 0 12px rgba(56,189,248,0.6); }
    .geo-button {
      padding: 8px 12px; border-radius: 999px; border: none;
      font-size: 0.8rem; cursor: pointer; white-space: nowrap;
      background: linear-gradient(135deg, #22c55e, #22d3ee);
      color: #020617; box-shadow: 0 10px 20px rgba(34,197,94,0.4);
    }
    .geo-button:hover { filter: brightness(1.06); }

    .airport-dd {
      position: absolute;
      left: 0; right: 0; top: calc(100% + 6px);
      background: rgba(2, 6, 23, 0.95);
      border: 1px solid rgba(148,163,184,0.25);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.65);
      z-index: 999;
      display: none;
    }
    .airport-dd.show { display: block; }
    .airport-dd-item {
      padding: 10px 12px; cursor: pointer;
      font-size: 0.86rem; color: #e5ecff;
      border-bottom: 1px solid rgba(148,163,184,0.12);
    }
    .airport-dd-item:hover { background: rgba(56,189,248,0.12); }
    .airport-dd-empty { padding: 10px 12px; color: #a6b4d9; font-size: 0.85rem; }

    #alt-ft { accent-color: #22d3ee; }
    #wx-conditions, #wx-wind, #winds-aloft { text-shadow: 0 0 18px rgba(56,189,248,0.25); }

    @media (max-width: 900px) {
      .dashboard-title { flex-direction: column; align-items: flex-start; }
      .dashboard-grid { grid-template-columns: 1fr; }
    }

    section.tools-section { background: white; color: black; padding: 60px 30px; text-align: center; }
    h2 { margin-bottom: 40px; }
    .button-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
    .tool-button {
      background: black; color: white; padding: 20px 30px; border-radius: 10px;
      font-size: 1rem; font-weight: bold; text-decoration: none;
      width: 260px; transition: transform 0.2s ease;
    }
    .tool-button:hover { background: #222; transform: scale(1.05); }

    footer { text-align: center; padding: 20px; font-size: 0.8rem; color: #aaa; background: #000; }

    lottie-player { width: 300px; height: 300px; margin: 20px auto; display: block; }
    @media (min-width: 768px) { lottie-player { width: 800px !important; height: 400px !important; } }
    @media (max-width: 600px) {
      header { padding: 60px 20px 30px; }
      lottie-player { width: 90% !important; max-width: 320px; height: auto !important; }
      .tool-button { width: 90%; }
    }

    /* METAR pill */
    .metar-pill {
      display: inline-flex; align-items: center; justify-content: center;
      padding: 4px 10px; border-radius: 999px;
      font-size: 0.72rem; letter-spacing: 0.08em; text-transform: uppercase;
      border: 1px solid rgba(148,163,184,0.25);
      background: rgba(2, 6, 23, 0.55);
      color: #cfe6ff;
    }
    .metar-pill.good { border-color: rgba(34,197,94,0.35); box-shadow: 0 0 18px rgba(34,197,94,0.18); }
    .metar-pill.warn { border-color: rgba(251,191,36,0.35); box-shadow: 0 0 18px rgba(251,191,36,0.14); }
    .metar-pill.bad  { border-color: rgba(239,68,68,0.35); box-shadow: 0 0 18px rgba(239,68,68,0.14); }

    /* Google-style METAR grid */
    .metar-grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap:12px;
      margin-top: 8px;
    }
    .metar-kv{
      border: 1px solid rgba(148,163,184,0.18);
      background: rgba(2,6,23,0.35);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .metar-kv-span{ grid-column: 1 / -1; }
    .metar-k2{
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: #9ca3ff;
      margin-bottom: 4px;
    }
    .metar-v2{
      font-size: 1.0rem;
      font-weight: 650;
      color: #e0f2ff;
    }
    .metar-collapse{
      width:100%;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.22);
      background: rgba(15,23,42,0.55);
      color:#cfe6ff;
      cursor:pointer;
      font-weight: 650;
    }
    .metar-collapse:hover{
      border-color: rgba(56,189,248,0.55);
      box-shadow: 0 0 14px rgba(56,189,248,0.18);
    }
    .metar-raw {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(15,23,42,0.55);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.86rem;
      color: #cbd5ff;
      white-space: pre-wrap;
      word-break: break-word;
      border: 1px solid rgba(148,163,184,0.18);
    }
  </style>
</head>

<body>
  <header data-aos="fade-down">
    <h1>✈ ISA Master Tool</h1>
    <p>Aerospace engineering tools for atmosphere, performance, and mission planning</p>
    <h3>Created by Ashwin Ganesh</h3>

    <lottie-player
      src="https://lottie.host/68ecc80f-3865-4071-89bf-1db845e65c6e/O67It7eqk8.json"
      background="transparent"
      speed="1"
      loop
      autoplay>
    </lottie-player>
  </header>

  <section class="dashboard-section">
    <div class="dashboard-title" data-aos="fade-up">
      <div>
        <div class="dashboard-title-main">ISA Command Center</div>
        <div class="dashboard-subtext">Live cockpit: weather, winds aloft, METAR, and ISA AI.</div>
      </div>
      <div class="tag-pill">Dashboard</div>
    </div>

    <div class="dashboard-grid">
      <div class="dash-card" data-aos="zoom-in" data-aos-delay="50">
        <h3>Local Time & Winds Aloft</h3>
        <div class="dash-row">
          <div>
            <div class="metric-label">City</div>
            <div class="big-city" id="city-label">Long Beach, CA</div>
            <div class="date-line" id="date-line"></div>
          </div>
          <div style="text-align:right;">
            <div class="metric-label">Current Time</div>
            <div class="big-time" id="clock">--:--</div>
          </div>
        </div>

        <div class="divider-line"></div>

        <div class="dash-row">
          <div style="flex:1;">
            <div class="metric-label">Cruise Altitude (ft)</div>
            <input id="alt-ft" type="range" min="0" max="42000" step="1000" value="8000" style="width:100%;">
            <div class="metric-small"><span id="alt-ft-label">8,000</span> ft</div>
          </div>

          <div style="text-align:right; min-width: 160px;">
            <div class="metric-label">Winds Aloft</div>
            <div class="metric-value" id="winds-aloft">Loading…</div>
            <div class="metric-small" id="winds-aloft-sub">—</div>
          </div>
        </div>
      </div>

      <div class="dash-card" data-aos="zoom-in" data-aos-delay="150">
        <h3>Surface Weather Snapshot</h3>

        <div class="dash-row">
          <div>
            <div class="metric-label">Conditions</div>
            <div class="metric-value" id="wx-conditions">Loading…</div>
            <div class="metric-small" id="wx-sub">—</div>
          </div>

          <div style="text-align:right;">
            <div class="metric-label">Wind • Pressure</div>
            <div class="metric-value" id="wx-wind">—</div>
            <div class="metric-small" id="wx-pressure">—</div>
          </div>
        </div>

        <div class="divider-line"></div>

        <div class="metric-label" style="margin-bottom:6px;">Next Hours</div>
        <div class="forecast-row"><span id="fh-1t">—</span><span id="fh-1w">—</span><span id="fh-1s">—</span></div>
        <div class="forecast-row"><span id="fh-2t">—</span><span id="fh-2w">—</span><span id="fh-2s">—</span></div>
        <div class="forecast-row"><span id="fh-3t">—</span><span id="fh-3w">—</span><span id="fh-3s">—</span></div>
        <div class="forecast-row"><span id="fh-4t">—</span><span id="fh-4w">—</span><span id="fh-4s">—</span></div>
      </div>

      <!-- METAR CARD (Google-style) -->
      <div class="dash-card" data-aos="zoom-in" data-aos-delay="250">
        <h3>METAR</h3>

        <div class="metric-label">Search Airport (ICAO, IATA, City)</div>
        <div class="airport-row">
          <input id="airport-search" class="airport-input" type="text"
                 placeholder="e.g. KLAX, LAX, Colombo, Heathrow" autocomplete="off" />
          <button type="button" class="geo-button" id="metar-btn">Get METAR</button>
          <div id="airport-dd" class="airport-dd"></div>
        </div>

        <div class="divider-line"></div>

        <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
          <div>
            <div class="metric-label">Station</div>
            <div class="metric-value" id="metar-station">—</div>
            <div class="metric-small" id="metar-observed">—</div>
          </div>

          <div style="text-align:right;">
            <div class="metric-label">Flight Rules</div>
            <span class="metar-pill warn" id="metar-flightcat">—</span>
            <div class="metric-small" id="metar-flightreason">—</div>
          </div>
        </div>

        <div class="divider-line"></div>

        <div class="metric-label">Weather Summary</div>
        <div class="metric-value" id="metar-summary">Type an airport above…</div>
        <div class="metric-small" id="metar-summary-sub">—</div>

        <div class="divider-line"></div>

        <div class="metar-grid">
          <div class="metar-kv">
            <div class="metar-k2">Temperature</div>
            <div class="metar-v2" id="metar-temp">—</div>
          </div>
          <div class="metar-kv">
            <div class="metar-k2">Dew Point</div>
            <div class="metar-v2" id="metar-dew">—</div>
          </div>
          <div class="metar-kv">
            <div class="metar-k2">Humidity</div>
            <div class="metar-v2" id="metar-rh">—</div>
          </div>
          <div class="metar-kv">
            <div class="metar-k2">Pressure</div>
            <div class="metar-v2" id="metar-pres">—</div>
          </div>
          <div class="metar-kv">
            <div class="metar-k2">Wind</div>
            <div class="metar-v2" id="metar-wind">—</div>
          </div>
          <div class="metar-kv">
            <div class="metar-k2">Visibility</div>
            <div class="metar-v2" id="metar-vis">—</div>
          </div>
          <div class="metar-kv metar-kv-span">
            <div class="metar-k2">Sky / Ceiling</div>
            <div class="metar-v2" id="metar-sky">—</div>
          </div>
        </div>

        <div class="divider-line"></div>

        <button class="metar-collapse" type="button" id="metar-toggle">Show raw METAR</button>
        <div class="metar-raw hidden" id="metar-raw">—</div>
      </div>

      <div class="dash-card" data-aos="zoom-in" data-aos-delay="350">
        <h3>Aerospace News &amp; ISA AI</h3>

        <div class="metric-label">Links (news feed comes next)</div>
        <div class="news-bullet">• <a class="news-link" href="https://www.nasa.gov/news-release/" target="_blank" rel="noopener">NASA updates</a></div>
        <div class="news-bullet">• <a class="news-link" href="https://www.flightglobal.com/news" target="_blank" rel="noopener">FlightGlobal</a></div>
        <div class="news-bullet">• <a class="news-link" href="https://spacenews.com/" target="_blank" rel="noopener">SpaceNews</a></div>

        <div class="divider-line"></div>

        <div class="metric-label">Ask ISA AI</div>
        <div class="metric-small" style="margin-bottom:6px;">Ask any aerospace question. Answer appears below.</div>

        <div class="ai-search">
          <input id="ai-query" class="ai-input" type="text" placeholder="e.g. Explain lift vs drag at high Mach"/>
          <button class="ai-button" type="button" onclick="askISA()">Ask</button>
        </div>

        <div id="ai-status" class="ai-status"></div>
        <div id="ai-answer" class="ai-answer-bubble hidden"></div>
      </div>
    </div>
  </section>

  <section class="tools-section">
    <h2 data-aos="fade-up">Choose a Tool</h2>
    <div class="button-grid">
      <a href="https://isa-atm-calculator-tmepkr7qfrryb65yvtjg7j.streamlit.app/?tool=ISA%20Air%20Properties" class="tool-button" data-aos="zoom-in" data-aos-delay="100">ISA Air Properties</a>
      <a href="https://isa-atm-calculator-tmepkr7qfrryb65yvtjg7j.streamlit.app/?tool=Mach%20Number%20Calculator" class="tool-button" data-aos="zoom-in" data-aos-delay="200">Mach Number Calculator</a>
      <a href="https://isa-atm-calculator-tmepkr7qfrryb65yvtjg7j.streamlit.app/?tool=Lift%20and%20Drag%20Calculator" class="tool-button" data-aos="zoom-in" data-aos-delay="300">Lift &amp; Drag Calculator</a>
      <a href="https://isa-atm-calculator-tmepkr7qfrryb65yvtjg7j.streamlit.app/?tool=Fuel%20Consumption%20%26%20Range%20Estimator" class="tool-button" data-aos="zoom-in" data-aos-delay="400">Fuel &amp; Range Estimator</a>
      <a href="https://isa-atm-calculator-tmepkr7qfrryb65yvtjg7j.streamlit.app/?tool=Mission%20Planner" class="tool-button" data-aos="zoom-in" data-aos-delay="500">Mission Planner</a>
      <a href="https://isa-atm-calculator-tmepkr7qfrryb65yvtjg7j.streamlit.app/?tool=City%20to%20City%20Flight%20Estimator" class="tool-button" data-aos="zoom-in" data-aos-delay="600">City to City Estimator</a>
    </div>
  </section>

  <footer>&copy; 2025 Ashwin Ganesh — All rights reserved</footer>

  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

  <script>
    AOS.init({ duration: 900, easing: 'ease-out-cubic', offset: 120, once: true });

    function updateClock() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, "0");
      const mins = String(now.getMinutes()).padStart(2, "0");
      document.getElementById("clock").textContent = `${hours}:${mins}`;
      const options = { weekday: "long", day: "numeric", month: "short", year: "numeric" };
      document.getElementById("date-line").textContent = now.toLocaleDateString(undefined, options);
    }
    updateClock();
    setInterval(updateClock, 1000);

    // ===== ISA AI =====
    const ISA_BACKEND_BASE = "https://isa-backend-olj9.onrender.com/api";
    const ISA_AI_ENDPOINT = `${ISA_BACKEND_BASE}/ask/`;
    const ISA_METAR_ENDPOINT = `${ISA_BACKEND_BASE}/metar`;

    async function askISA() {
      const input = document.getElementById("ai-query");
      const statusEl = document.getElementById("ai-status");
      const answerEl = document.getElementById("ai-answer");
      const question = (input.value || "").trim();
      if (!question) return;

      statusEl.textContent = "Thinking...";
      answerEl.classList.add("hidden");
      answerEl.classList.remove("show");

      try {
        const resp = await fetch(ISA_AI_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question })
        });

        const text = await resp.text();
        let data = null;
        try { data = JSON.parse(text); } catch {}

        if (!resp.ok) {
          const detail = data?.detail || text || `HTTP ${resp.status}`;
          throw new Error(`AI error (${resp.status}): ${detail}`);
        }

        answerEl.textContent = data?.answer || "No answer returned.";
      } catch (err) {
        console.error(err);
        answerEl.textContent = String(err.message || err);
      } finally {
        statusEl.textContent = "";
        answerEl.classList.remove("hidden");
        requestAnimationFrame(() => answerEl.classList.add("show"));
      }
    }

    // ===== METAR + Airport Search =====
    let AIRPORTS = [];
    let fuse = null;
    let metarAbort = null;

    const searchEl = document.getElementById("airport-search");
    const ddEl = document.getElementById("airport-dd");
    const metarBtn = document.getElementById("metar-btn");

    const stationEl = document.getElementById("metar-station");
    const observedEl = document.getElementById("metar-observed");
    const flightCatEl = document.getElementById("metar-flightcat");
    const flightReasonEl = document.getElementById("metar-flightreason");

    const summaryEl = document.getElementById("metar-summary");
    const summarySubEl = document.getElementById("metar-summary-sub");

    const tempEl = document.getElementById("metar-temp");
    const dewEl = document.getElementById("metar-dew");
    const rhEl = document.getElementById("metar-rh");
    const presEl = document.getElementById("metar-pres");
    const windEl = document.getElementById("metar-wind");
    const visEl = document.getElementById("metar-vis");
    const skyEl = document.getElementById("metar-sky");

    const rawEl = document.getElementById("metar-raw");
    const toggleBtn = document.getElementById("metar-toggle");

    function showDropdown(on) {
      ddEl.classList.toggle("show", !!on);
    }

    function airportLabel(a) {
      const code = a.icao + (a.iata ? ` (${a.iata})` : "");
      const right = [a.city, a.name].filter(Boolean).join(" — ");
      const country = a.country ? ` · ${a.country}` : "";
      return right ? `${code} — ${right}${country}` : `${code}${country}`;
    }

    function setFlightBadge(cat){
      const c = String(cat || "—").toUpperCase();
      flightCatEl.textContent = c;
      flightCatEl.classList.remove("good","warn","bad");
      if (c === "VFR") flightCatEl.classList.add("good");
      else if (c === "MVFR") flightCatEl.classList.add("warn");
      else if (c === "IFR" || c === "LIFR") flightCatEl.classList.add("bad");
      else flightCatEl.classList.add("warn");
    }

    function parseCeilingFtFromSkyString(sky) {
      // handles: "Overcast @ 700 ft" or "Broken @ 1,200 ft"
      const m = String(sky || "").match(/@\s*([\d,]+)\s*ft/i);
      if (!m) return null;
      return parseInt(m[1].replace(/,/g,""), 10);
    }

    function flightCategory(visibilityMi, ceilingFt){
      // simple FAA-ish thresholds
      if (visibilityMi == null && ceilingFt == null) return {cat:"UNK", reason:"Missing vis/ceiling"};
      const vis = visibilityMi;
      const ceil = ceilingFt;

      // LIFR
      if ((vis != null && vis < 1) || (ceil != null && ceil < 500)) return {cat:"LIFR", reason:"Very low vis/ceiling"};
      // IFR
      if ((vis != null && vis < 3) || (ceil != null && ceil < 1000)) return {cat:"IFR", reason:"Low vis/ceiling"};
      // MVFR
      if ((vis != null && vis < 5) || (ceil != null && ceil < 3000)) return {cat:"MVFR", reason:"Marginal vis/ceiling"};
      // VFR
      return {cat:"VFR", reason:"Good vis and ceiling"};
    }

    function makeSummary(data){
      const sky = data.sky || "—";
      const vis = data.visibility_mi;
      const wdir = data.wind_dir_deg;
      const wspd = data.wind_speed_kt;
      const gust = data.wind_gust_kt;

      const parts = [];

      // Sky
      if (sky && sky !== "—") parts.push(sky.replace("@", "at"));

      // Visibility
      if (vis != null) {
        if (vis < 1) parts.push("very low visibility");
        else if (vis < 3) parts.push("low visibility");
        else if (vis < 5) parts.push("reduced visibility");
      }

      // Wind
      if (wspd != null) {
        if (wspd === 0) parts.push("calm wind");
        else {
          const dirTxt = (wdir == null) ? "variable" : `${wdir}°`;
          parts.push(`wind ${dirTxt} at ${wspd} kt${gust ? ` gust ${gust}` : ""}`);
        }
      }

      // Humidity hint (dewpoint spread)
      const t = data.temp_c;
      const d = data.dewpoint_c;
      if (t != null && d != null) {
        const spread = Math.abs(t - d);
        if (spread <= 2) parts.push("very humid (fog/mist possible)");
      }

      const headline = parts.length ? parts.join(", ") : "Weather details available below.";
      let sub = "Derived from METAR. Raw METAR is available below.";

      return { headline: headline.charAt(0).toUpperCase() + headline.slice(1), sub };
    }

    // Raw METAR toggle
    toggleBtn.addEventListener("click", () => {
      const isHidden = rawEl.classList.contains("hidden");
      rawEl.classList.toggle("hidden", !isHidden);
      toggleBtn.textContent = isHidden ? "Hide raw METAR" : "Show raw METAR";
    });

    // Load local airports JSON (place airports.min.json next to index.html)
    fetch("./airports.min.json", { cache: "no-store" })
      .then(r => r.json())
      .then(data => {
        AIRPORTS = data || [];
        fuse = new Fuse(AIRPORTS, {
          threshold: 0.35,
          keys: ["icao", "iata", "name", "city", "country"]
        });
      })
      .catch(err => {
        console.error("Could not load airports.min.json", err);
        fuse = null; // allow manual ICAO
      });

    function renderDropdown(list) {
      ddEl.innerHTML = "";
      if (!list || !list.length) {
        ddEl.innerHTML = `<div class="airport-dd-empty">No matches — press Enter to try ICAO</div>`;
        showDropdown(true);
        return;
      }

      list.slice(0, 10).forEach(a => {
        const d = document.createElement("div");
        d.className = "airport-dd-item";
        d.textContent = airportLabel(a);
        d.onmousedown = e => {
          e.preventDefault();
          searchEl.value = airportLabel(a);
          showDropdown(false);
          fetchMetar(a.icao);
        };
        ddEl.appendChild(d);
      });
      showDropdown(true);
    }

    let searchTimer = null;
    searchEl.addEventListener("input", () => {
      const q = (searchEl.value || "").trim();
      if (!q || q.length < 2 || !fuse) { showDropdown(false); return; }
      if (searchTimer) clearTimeout(searchTimer);
      searchTimer = setTimeout(() => {
        const res = fuse.search(q).map(r => r.item);
        renderDropdown(res);
      }, 120);
    });

    document.addEventListener("click", (e) => {
      if (!ddEl.contains(e.target) && e.target !== searchEl) showDropdown(false);
    });

    searchEl.addEventListener("keydown", (e) => {
      if (e.key === "Escape") { showDropdown(false); return; }
      if (e.key === "Enter") {
        e.preventDefault();
        showDropdown(false);
        fetchMetar(searchEl.value);
      }
    });

    metarBtn.addEventListener("click", () => fetchMetar(searchEl.value));

    function extractICAO(text) {
      const t = String(text || "").trim().toUpperCase();
      const m4 = t.match(/\b[A-Z0-9]{4}\b/);
      if (m4) return m4[0];
      const m3 = t.match(/\b[A-Z0-9]{3}\b/);
      return m3 ? m3[0] : null;
    }

    function setLoading(code){
      stationEl.textContent = code || "—";
      observedEl.textContent = "Loading…";
      setFlightBadge("—");
      flightReasonEl.textContent = "—";
      summaryEl.textContent = "Fetching METAR…";
      summarySubEl.textContent = "—";
      tempEl.textContent = "—";
      dewEl.textContent = "—";
      rhEl.textContent = "—";
      presEl.textContent = "—";
      windEl.textContent = "—";
      visEl.textContent = "—";
      skyEl.textContent = "—";
      rawEl.textContent = "—";
      rawEl.classList.add("hidden");
      toggleBtn.textContent = "Show raw METAR";
    }

    async function fetchMetar(input) {
      const code = extractICAO(input);
      if (!code) {
        stationEl.textContent = "—";
        summaryEl.textContent = "Type an ICAO code like KLAX (or choose from the list).";
        summarySubEl.textContent = "—";
        setFlightBadge("Invalid");
        flightReasonEl.textContent = "Invalid station code";
        return;
      }

      if (metarAbort) metarAbort.abort();
      metarAbort = new AbortController();
      const timeout = setTimeout(() => metarAbort.abort(), 12000);

      setLoading(code);

      try {
        const res = await fetch(`${ISA_METAR_ENDPOINT}/${encodeURIComponent(code)}?t=${Date.now()}`, {
          signal: metarAbort.signal,
          cache: "no-store"
        });

        if (res.status === 204) {
          summaryEl.textContent = "No METAR available for that station (or not recent).";
          summarySubEl.textContent = "Try another station code.";
          setFlightBadge("No report");
          flightReasonEl.textContent = "No recent METAR returned";
          return;
        }

        const data = await res.json();
        if (!data?.raw_text) {
          summaryEl.textContent = "No METAR available.";
          summarySubEl.textContent = "Try another station code.";
          setFlightBadge("No report");
          flightReasonEl.textContent = "No raw METAR returned";
          return;
        }

        // Station + time
        stationEl.textContent = data.icao || code;
        const obsIso = data.obs_time_utc || null;
        if (obsIso) {
          const d = new Date(obsIso);
          observedEl.textContent = isNaN(d.getTime()) ? obsIso : d.toLocaleString([], { weekday:"short", month:"short", day:"numeric", hour:"2-digit", minute:"2-digit", timeZoneName:"short" });
        } else {
          observedEl.textContent = "—";
        }

        // Key conditions
        const tc = data.temp_c;
        const dc = data.dewpoint_c;
        const rh = data.humidity_est_pct;
        const p  = data.altimeter_inhg;
        const vis = data.visibility_mi;
        const sky = data.sky;
        const wdir = data.wind_dir_deg;
        const wspd = data.wind_speed_kt;
        const gust = data.wind_gust_kt;

        tempEl.textContent = (tc == null) ? "—" : `${tc} °C`;
        dewEl.textContent = (dc == null) ? "—" : `${dc} °C`;
        rhEl.textContent  = (rh == null) ? "—" : `${rh}%`;
        presEl.textContent = (p == null) ? "—" : `${p} inHg`;
        visEl.textContent = (vis == null) ? "—" : `${vis} mi`;

        if (wspd == null) windEl.textContent = "—";
        else if (wspd === 0) windEl.textContent = "Calm";
        else {
          const dirTxt = (wdir == null) ? "VRB" : `${wdir}°`;
          windEl.textContent = `${dirTxt} / ${wspd} kt${gust ? ` (G${gust})` : ""}`;
        }

        skyEl.textContent = sky || "—";

        // Summary
        const s = makeSummary(data);
        summaryEl.textContent = s.headline;
        summarySubEl.textContent = s.sub;

        // Flight category
        const ceilingFt = parseCeilingFtFromSkyString(sky);
        const fc = flightCategory(vis, ceilingFt);
        setFlightBadge(fc.cat);
        flightReasonEl.textContent = fc.reason;

        // Raw
        rawEl.textContent = data.raw_text;

      } catch (e) {
        console.error(e);
        if (e?.name === "AbortError") {
          summaryEl.textContent = "Timed out fetching METAR. Try again.";
          summarySubEl.textContent = "Backend request exceeded 12 seconds.";
          setFlightBadge("Timeout");
          flightReasonEl.textContent = "Request timed out";
        } else {
          summaryEl.textContent = "METAR fetch failed.";
          summarySubEl.textContent = "Check backend status / station code.";
          setFlightBadge("Error");
          flightReasonEl.textContent = "Request error";
        }
      } finally {
        clearTimeout(timeout);
      }
    }

    // ===== Surface weather + winds aloft (unchanged) =====
    let ISA_LAT = 33.8177;
    let ISA_LON = -118.1516;

    function altitudeToPressureLevel(altFt) {
      if (altFt <= 5000) return 850;
      if (altFt <= 12000) return 700;
      if (altFt <= 18000) return 600;
      if (altFt <= 24000) return 500;
      if (altFt <= 30000) return 400;
      if (altFt <= 36000) return 300;
      return 250;
    }

    async function fetchSurfaceWeather(lat, lon) {
      const url =
        "https://api.open-meteo.com/v1/forecast?" +
        `latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}` +
        "&current=temperature_2m,relative_humidity_2m,pressure_msl,wind_speed_10m,wind_direction_10m" +
        "&hourly=temperature_2m,wind_speed_10m,wind_direction_10m" +
        "&forecast_days=1&timezone=auto";

      const res = await fetch(url);
      if (!res.ok) throw new Error("Open-Meteo weather fetch failed");
      const data = await res.json();

      const t = data.current.temperature_2m;
      const rh = data.current.relative_humidity_2m;
      const p = data.current.pressure_msl;
      const ws = data.current.wind_speed_10m;
      const wd = data.current.wind_direction_10m;

      const wsKt = (ws * 0.539957).toFixed(0);

      document.getElementById("wx-conditions").textContent = `${t.toFixed(0)}°C`;
      document.getElementById("wx-sub").textContent = `Humidity ${rh}%`;
      document.getElementById("wx-wind").textContent = `${wd.toFixed(0)}° / ${wsKt} kt`;
      document.getElementById("wx-pressure").textContent = `${p.toFixed(0)} hPa`;

      for (let i = 1; i <= 4; i++) {
        const time = data.hourly.time[i];
        const hhmm = new Date(time).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
        const ht = data.hourly.temperature_2m[i];
        const hws = data.hourly.wind_speed_10m[i];
        const hwd = data.hourly.wind_direction_10m[i];
        const hwsKt = (hws * 0.539957).toFixed(0);

        document.getElementById(`fh-${i}t`).textContent = hhmm;
        document.getElementById(`fh-${i}w`).textContent = `${ht.toFixed(0)}°C`;
        document.getElementById(`fh-${i}s`).textContent = `${hwd.toFixed(0)}° ${hwsKt} kt`;
      }
    }

    async function fetchWindsAloft(lat, lon, altFt) {
      const level = altitudeToPressureLevel(altFt);
      const url =
        "https://api.open-meteo.com/v1/forecast?" +
        `latitude=${encodeURIComponent(lat)}&longitude=${encodeURIComponent(lon)}` +
        `&hourly=windspeed_${level}hPa,winddirection_${level}hPa` +
        "&forecast_days=1&timezone=auto";

      const res = await fetch(url);
      if (!res.ok) throw new Error("Open-Meteo winds aloft fetch failed");
      const data = await res.json();

      const ws = data.hourly[`windspeed_${level}hPa`][0];
      const wd = data.hourly[`winddirection_${level}hPa`][0];
      const wsKt = (ws * 0.539957).toFixed(0);

      document.getElementById("winds-aloft").textContent = `${wd.toFixed(0)}° / ${wsKt} kt`;
      document.getElementById("winds-aloft-sub").textContent = `${level} hPa level`;
    }

    function refreshWXandWinds() {
      const alt = parseInt(document.getElementById("alt-ft").value, 10);
      document.getElementById("alt-ft-label").textContent = alt.toLocaleString();
      fetchSurfaceWeather(ISA_LAT, ISA_LON).catch(console.error);
      fetchWindsAloft(ISA_LAT, ISA_LON, alt).catch(console.error);
    }

    document.addEventListener("DOMContentLoaded", () => {
      refreshWXandWinds();

      const slider = document.getElementById("alt-ft");
      slider.addEventListener("input", () => {
        document.getElementById("alt-ft-label").textContent = parseInt(slider.value,10).toLocaleString();
      });
      slider.addEventListener("change", refreshWXandWinds);

      setInterval(refreshWXandWinds, 10 * 60 * 1000);

      // Default METAR
      fetchMetar("KLGB");
    });
  </script>
</body>
</html>