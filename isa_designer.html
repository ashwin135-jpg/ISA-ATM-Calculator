<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ISA Designer ‚Äî Aircraft Designer</title>

  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

  <style>
    :root{
      --bg0:#050816;
      --bg1:#020617;
      --panel: rgba(15,23,42,0.62);
      --panel2: rgba(2,6,23,0.55);
      --border: rgba(148,163,184,0.22);
      --borderHi: rgba(56,189,248,0.55);
      --text:#e5ecff;
      --muted:#a6b4d9;
      --muted2:#c0cbe9;
      --pill:#0b1224;
      --shadow: 0 22px 55px rgba(0,0,0,0.65);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family: 'Segoe UI', sans-serif;
      background: radial-gradient(circle at top, var(--bg0) 0, var(--bg1) 55%, #000 100%);
      color: var(--text);
    }

    header{
      text-align:center;
      padding: 26px 18px 10px;
    }
    header h1{ margin:0 0 6px; font-size: 2.0rem; }
    header p{ margin:0; color:#c9d2ee; font-size: 1.0rem; }
    header .sub{ margin-top:8px; color: var(--muted); font-size: .9rem; }

    .topNav{
      max-width: 1180px;
      margin: 0 auto 14px;
      padding: 0 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
    }
    .backLink{
      text-decoration:none;
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-size: .92rem;
      color: #cfe6ff;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(2, 6, 23, 0.45);
    }
    .backLink:hover{
      border-color: var(--borderHi);
      box-shadow: 0 0 14px rgba(56,189,248,0.18);
    }

    .tag-pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 5px 12px;
      border-radius: 999px;
      font-size: .72rem;
      text-transform: uppercase;
      letter-spacing: .09em;
      background: linear-gradient(135deg, rgba(34,211,238,0.18), rgba(129,140,248,0.25));
      color: #e0faff;
      border: 1px solid rgba(56,189,248,0.6);
      box-shadow: 0 0 16px rgba(45,212,191,0.28);
      white-space: nowrap;
    }

    .wrap{
      max-width: 1180px;
      margin: 0 auto;
      padding: 0 18px 60px;
    }

    .titleRow{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      margin: 10px 0 14px;
    }
    .titleMain{ font-size: 1.25rem; font-weight: 700; letter-spacing: .02em; }
    .titleSub{ font-size: .92rem; color: var(--muted); margin-top: 6px; }

    .statusRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 5px 10px;
      border-radius: 999px;
      font-size: .72rem;
      letter-spacing: .08em;
      text-transform: uppercase;
      border: 1px solid var(--border);
      background: rgba(2, 6, 23, 0.55);
      color: #cfe6ff;
    }
    .pill.good { border-color: rgba(34,197,94,0.35); box-shadow: 0 0 18px rgba(34,197,94,0.12); }
    .pill.warn { border-color: rgba(251,191,36,0.35); box-shadow: 0 0 18px rgba(251,191,36,0.10); }
    .pill.bad  { border-color: rgba(239,68,68,0.35); box-shadow: 0 0 18px rgba(239,68,68,0.10); }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 9px 14px;
      border-radius: 999px;
      border:none;
      font-size: .86rem;
      font-weight: 750;
      cursor:pointer;
      background: linear-gradient(135deg, #22c55e, #22d3ee);
      color: #020617;
      box-shadow: 0 14px 28px rgba(34,197,94,0.22);
      transition: transform .15s ease, filter .15s ease, box-shadow .15s ease;
      white-space: nowrap;
    }
    .btn:hover{ filter: brightness(1.06); transform: translateY(-1px); box-shadow: 0 20px 40px rgba(34,197,94,0.32); }
    .btn.secondary{
      background: rgba(2, 6, 23, 0.55);
      border: 1px solid var(--border);
      color: #cfe6ff;
      box-shadow: none;
    }
    .btn.secondary:hover{
      border-color: var(--borderHi);
      box-shadow: 0 0 14px rgba(56,189,248,0.18);
      transform: translateY(-1px);
      filter:none;
    }

    /* --- Main two-column layout (like screenshot) --- */
    .grid{
      display:grid;
      grid-template-columns: 1.05fr 1.35fr;
      gap: 18px;
      align-items:start;
    }

    .card{
      background: radial-gradient(circle at top left, rgba(17,24,39,0.85) 0, rgba(2,6,23,0.75) 75%);
      border-radius: 22px;
      padding: 14px 14px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      position: relative;
      overflow:hidden;
    }

    .cardHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 4px 6px 10px;
    }
    .cardTitle{
      font-size: .95rem;
      font-weight: 750;
      letter-spacing: .06em;
      text-transform: uppercase;
      color: #f2f6ff;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .divider{
      height: 1px;
      background: linear-gradient(to right, transparent, rgba(148,163,184,0.45), transparent);
      margin: 10px 0;
    }

    /* --- 3D Preview area --- */
    .previewFrame{
      height: 360px;
      border-radius: var(--radius);
      border: 1px solid rgba(148,163,184,0.18);
      background:
        radial-gradient(circle at 50% 30%, rgba(56,189,248,0.12), transparent 55%),
        radial-gradient(circle at 50% 80%, rgba(129,140,248,0.10), transparent 55%),
        rgba(2,6,23,0.35);
      overflow:hidden;
      position: relative;
    }
    canvas#threeCanvas{
      width:100%;
      height:100%;
      display:block;
    }
    .previewOverlay{
      position:absolute;
      inset: 10px 10px auto auto;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
      pointer-events:none;
    }
    .miniPill{
      pointer-events:none;
      font-size:.72rem;
      border-radius:999px;
      padding: 5px 10px;
      border: 1px solid rgba(148,163,184,0.18);
      background: rgba(2,6,23,0.55);
      color:#d6e6ff;
      font-variant-numeric: tabular-nums;
    }

    /* --- AI CAD block --- */
    .cadBtn{
      width:100%;
      padding: 11px 14px;
      border-radius: 12px;
      border: 1px solid rgba(168,85,247,0.35);
      background: linear-gradient(90deg, rgba(168,85,247,0.88), rgba(236,72,153,0.78));
      color: #071022;
      font-weight: 800;
      cursor:pointer;
      box-shadow: 0 16px 36px rgba(236,72,153,0.18);
      transition: transform .15s ease, filter .15s ease;
    }
    .cadBtn:hover{ transform: translateY(-1px); filter: brightness(1.04); }

    /* --- Right panel tabs + fields --- */
    .tabs{
      display:inline-flex;
      gap:6px;
      padding: 4px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.18);
      background: rgba(2,6,23,0.35);
    }
    .tab{
      border:none;
      background: transparent;
      color: rgba(229,236,255,0.62);
      font-weight: 750;
      font-size: .82rem;
      padding: 7px 10px;
      border-radius: 10px;
      cursor:pointer;
    }
    .tab.active{
      background: rgba(229,236,255,0.92);
      color: #0b1224;
    }

    .field{
      margin: 10px 4px;
      padding: 10px 12px;
      border: 1px solid rgba(148,163,184,0.14);
      background: rgba(2,6,23,0.35);
      border-radius: 14px;
    }
    .fieldLabel{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      margin-bottom: 8px;
      color: #dbe8ff;
      font-weight: 650;
      font-size: .9rem;
    }
    .fieldLabel span.meta{
      color: var(--muted);
      font-weight: 650;
      font-size: .82rem;
      font-variant-numeric: tabular-nums;
    }

    select, input[type="range"], input[type="number"]{
      width:100%;
    }
    select{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      outline:none;
    }
    input[type="range"]{
      accent-color: #60a5fa;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 140px;
      gap:10px;
      align-items:center;
      margin-top: 8px;
    }
    input[type="number"]{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      outline:none;
    }

    .actionRow{
      display:flex;
      gap:10px;
      margin-top: 12px;
      padding: 0 4px 4px;
    }
    .primaryWide{
      flex:1;
      border-radius: 12px;
      padding: 12px 14px;
      font-weight: 850;
      background: linear-gradient(90deg, rgba(34,211,238,0.70), rgba(59,130,246,0.75));
      color:#041024;
      border:none;
      cursor:pointer;
      box-shadow: 0 16px 36px rgba(59,130,246,0.16);
      transition: transform .15s ease, filter .15s ease;
    }
    .primaryWide:hover{ transform: translateY(-1px); filter: brightness(1.04); }

    .resultsGrid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 0 4px 4px;
    }
    .kpi{
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,0.14);
      background: rgba(2,6,23,0.35);
      padding: 10px 12px;
    }
    .kpi .k{ color: var(--muted); font-size: .74rem; text-transform: uppercase; letter-spacing: .09em; }
    .kpi .v{ margin-top: 5px; font-weight: 850; font-variant-numeric: tabular-nums; }

    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .warnBox{
      margin: 10px 4px 2px;
      border: 1px solid rgba(148,163,184,0.14);
      background: rgba(2,6,23,0.35);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .warnBox h4{
      margin: 0 0 8px;
      font-size: .78rem;
      text-transform: uppercase;
      letter-spacing: .1em;
      color: #9ca3ff;
    }
    .warnItem{ display:flex; gap:10px; padding: 8px 0; border-top: 1px solid rgba(148,163,184,0.10); }
    .warnItem:first-of-type{ border-top:none; }
    .dot{ width:10px; height:10px; border-radius:999px; margin-top: 4px; background: #fbbf24; box-shadow: 0 0 14px rgba(251,191,36,0.12); flex: 0 0 auto; }
    .dot.good{ background: #22c55e; box-shadow: 0 0 14px rgba(34,197,94,0.12); }
    .warnText{ font-size: .88rem; color: #d3e2ff; line-height: 1.35; }

    .mutedSmall{ color: var(--muted); font-size: .88rem; padding: 0 4px; line-height: 1.45; }

    footer{
      text-align:center;
      padding: 18px;
      font-size: .82rem;
      color:#9aa3b6;
      background: #000;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .previewFrame{ height: 320px; }
    }
  </style>
</head>

<body>
  <header data-aos="fade-down">
    <h1>üõ†Ô∏è ISA Designer</h1>
    <p>Design your own air vehicle with real engineering parameters</p>
    <div class="sub">Now supports: <span class="mono">UAV</span> ‚Ä¢ <span class="mono">Electric UAV</span> ‚Ä¢ <span class="mono">Hybrid UAV</span> ‚Ä¢ <span class="mono">Commercial Plane</span></div>
  </header>

  <div class="topNav" data-aos="fade-up">
    <a class="backLink" href="index.html">‚Üê Back to ISA Home</a>
    <div class="tag-pill">Aircraft Designer</div>
  </div>

  <div class="wrap">
    <div class="titleRow" data-aos="fade-up">
      <div>
        <div class="titleMain">ISA Aircraft Designer</div>
        <div class="titleSub">Edit key parameters, see 3D geometry update instantly, and compute performance from the backend.</div>
      </div>
      <div class="statusRow">
        <span class="pill" id="statusPill">Loading‚Ä¶</span>
        <button class="btn secondary" id="btnReset" type="button">Reset</button>
        <button class="btn secondary" id="btnExport" type="button">Export Spreadsheet</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT COLUMN -->
      <div>
        <!-- 3D Preview -->
        <div class="card" data-aos="zoom-in" data-aos-delay="50">
          <div class="cardHead">
            <div class="cardTitle">üßä 3D Preview</div>
            <div class="pill" id="renderPill">Renderer: ON</div>
          </div>
          <div class="previewFrame">
            <canvas id="threeCanvas"></canvas>
            <div class="previewOverlay">
              <div class="miniPill mono" id="miniAR">AR: ‚Äî</div>
              <div class="miniPill mono" id="miniMAC">MAC: ‚Äî</div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="mutedSmall">
            Live parametric mesh (fuselage + wing + tail). Next: nicer airfoils, landing gear, nacelles, and exportable geometry.
          </div>
        </div>

        <!-- AI CAD Rendering -->
        <div class="card" data-aos="zoom-in" data-aos-delay="90" style="margin-top: 14px;">
          <div class="cardHead">
            <div class="cardTitle">‚ú® AI CAD Rendering</div>
            <span class="pill">Beta</span>
          </div>
          <button class="cadBtn" id="btnCad" type="button">Generate CAD Rendering</button>
          <div class="divider"></div>
          <div class="mutedSmall">
            This can call your future endpoint (e.g., <span class="mono">/api/designer/cad</span>) to generate clean concept renders.
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN -->
      <div class="card" data-aos="zoom-in" data-aos-delay="120">
        <div class="cardHead">
          <div class="cardTitle">üß≠ Design Parameters</div>
          <button class="btn secondary" id="btnSoftReset" type="button">Reset</button>
        </div>

        <div style="padding: 0 6px 10px;">
          <div class="tabs">
            <button class="tab active" data-tab="basic">Basic</button>
            <button class="tab" data-tab="aero">Aerodynamics</button>
            <button class="tab" data-tab="perf">Performance</button>
          </div>
        </div>

        <!-- BASIC TAB -->
        <div class="tabPanel" id="tab-basic" style="padding: 0 4px;">
          <div class="field">
            <div class="fieldLabel">
              <span>Aircraft Type</span>
              <span class="meta mono" id="modelName">‚Äî</span>
            </div>
            <select id="vehicleType">
              <option value="uav">UAV</option>
              <option value="electric_uav">Electric UAV</option>
              <option value="hybrid_uav">Hybrid UAV</option>
              <option value="commercial">Commercial Plane</option>
            </select>
          </div>

          <div class="field">
            <div class="fieldLabel">
              <span id="lblMTOW">MTOW</span>
              <span class="meta mono" id="valMTOW">‚Äî</span>
            </div>
            <div class="row2">
              <input id="mtow" type="range" min="5" max="200" step="0.5"/>
              <input id="mtow_num" type="number" step="0.5"/>
            </div>
          </div>

          <div class="field">
            <div class="fieldLabel">
              <span id="lblSpan">Wing Span</span>
              <span class="meta mono" id="valSpan">‚Äî</span>
            </div>
            <div class="row2">
              <input id="wing_span" type="range" min="2" max="60" step="0.1"/>
              <input id="wing_span_num" type="number" step="0.1"/>
            </div>
          </div>

          <div class="field">
            <div class="fieldLabel">
              <span id="lblArea">Wing Area</span>
              <span class="meta mono" id="valArea">‚Äî</span>
            </div>
            <div class="row2">
              <input id="wing_area" type="range" min="0.5" max="200" step="0.1"/>
              <input id="wing_area_num" type="number" step="0.1"/>
            </div>
          </div>
        </div>

        <!-- AERO TAB -->
        <div class="tabPanel" id="tab-aero" style="display:none; padding: 0 4px;">
          <div class="field">
            <div class="fieldLabel">
              <span>Taper Ratio</span>
              <span class="meta mono" id="valTaper">‚Äî</span>
            </div>
            <div class="row2">
              <input id="taper_ratio" type="range" min="0.2" max="1.0" step="0.01"/>
              <input id="taper_ratio_num" type="number" step="0.01"/>
            </div>
          </div>

          <div class="field">
            <div class="fieldLabel">
              <span>CLmax</span>
              <span class="meta mono" id="valCLmax">‚Äî</span>
            </div>
            <div class="row2">
              <input id="cl_max" type="range" min="0.8" max="2.2" step="0.01"/>
              <input id="cl_max_num" type="number" step="0.01"/>
            </div>
          </div>

          <div class="field">
            <div class="fieldLabel">
              <span>CD0</span>
              <span class="meta mono" id="valCD0">‚Äî</span>
            </div>
            <div class="row2">
              <input id="cd0" type="range" min="0.008" max="0.08" step="0.001"/>
              <input id="cd0_num" type="number" step="0.001"/>
            </div>
          </div>

          <div class="field">
            <div class="fieldLabel">
              <span>Oswald e</span>
              <span class="meta mono" id="valE">‚Äî</span>
            </div>
            <div class="row2">
              <input id="oswald_e" type="range" min="0.55" max="0.95" step="0.01"/>
              <input id="oswald_e_num" type="number" step="0.01"/>
            </div>
          </div>
        </div>

        <!-- PERF TAB -->
        <div class="tabPanel" id="tab-perf" style="display:none; padding: 0 4px;">
          <div class="field">
            <div class="fieldLabel">
              <span id="lblCruise">Cruise Speed</span>
              <span class="meta mono" id="valCruise">‚Äî</span>
            </div>
            <div class="row2">
              <input id="cruise_speed" type="range" min="10" max="500" step="1"/>
              <input id="cruise_speed_num" type="number" step="1"/>
            </div>
          </div>

          <div class="field">
            <div class="fieldLabel">
              <span id="lblAlt">Altitude</span>
              <span class="meta mono" id="valAlt">‚Äî</span>
            </div>
            <div class="row2">
              <input id="altitude" type="range" min="0" max="40000" step="100"/>
              <input id="altitude_num" type="number" step="100"/>
            </div>
          </div>
        </div>

        <div class="actionRow">
          <button class="primaryWide" id="btnCompute" type="button">Calculate Performance</button>
        </div>

        <div class="resultsGrid">
          <div class="kpi"><div class="k">CL @ Cruise</div><div class="v mono" id="outCL">‚Äî</div></div>
          <div class="kpi"><div class="k">L/D</div><div class="v mono" id="outLD">‚Äî</div></div>
          <div class="kpi"><div class="k">Drag @ Cruise</div><div class="v mono" id="outD">‚Äî</div></div>
          <div class="kpi"><div class="k">Stall Speed</div><div class="v mono" id="outVstall">‚Äî</div></div>
          <div class="kpi"><div class="k">Power Required</div><div class="v mono" id="outP">‚Äî</div></div>
          <div class="kpi"><div class="k">Endurance / Range</div><div class="v mono" id="outER">‚Äî</div></div>
        </div>

        <div class="warnBox">
          <h4>Diagnostics</h4>
          <div id="warnList"></div>
        </div>

        <div class="divider"></div>
        <div class="mutedSmall">
          Backend endpoints: <span class="mono">/api/designer/default</span>, <span class="mono">/api/designer/compute</span>, <span class="mono">/api/designer/export</span>
        </div>
      </div>
    </div>
  </div>

  <footer>&copy; 2026 Ashwin Ganesh ‚Äî All rights reserved</footer>

  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

  <!-- Three.js (unpkg) -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script>

  <script>
  AOS.init({ duration: 850, easing: 'ease-out-cubic', offset: 120, once: true });

  // ===== Backend base =====
  const ISA_BACKEND_BASE = "https://isa-backend-olj9.onrender.com/api";
  const DESIGNER_DEFAULT = `${ISA_BACKEND_BASE}/designer/default`;
  const DESIGNER_COMPUTE = `${ISA_BACKEND_BASE}/designer/compute`;
  const DESIGNER_EXPORT  = `${ISA_BACKEND_BASE}/designer/export`;

  // ===== State =====
  let state = null;
  let computeTimer = null;

  const $ = (id)=>document.getElementById(id);

  function setPill(el, text, mode){
    el.textContent = text;
    el.classList.remove("good","warn","bad");
    if(mode) el.classList.add(mode);
  }

  function num(x, digits=2){
    if (x === null || x === undefined || Number.isNaN(x)) return "‚Äî";
    return Number(x).toFixed(digits);
  }

  // ===== Small helpers (state-safe) =====
  function setScalar(obj, value, unit){
    if(!obj) return { value, unit };
    obj.value = value;
    obj.unit = unit;
    return obj;
  }

  function ensure(obj, key, fallback){
    if(obj[key] === undefined || obj[key] === null) obj[key] = fallback;
    return obj[key];
  }

  function clamp(v, min, max){
    return Math.min(max, Math.max(min, v));
  }

  // =======================
  // Vehicle Types (UI presets)
  // NOTE: Keep v1 UI imperial to match backend state keys (lb/ft),
  // even if you label "commercial" as metric later.
  // =======================
  const VEHICLE_PRESETS = {
    uav: {
      name: "UAV",
      mtow:   {min: 5, max: 200, step: 0.5, value: 55, label:"MTOW (lb)"},
      span:   {min: 2, max: 60, step: 0.1, value: 18, label:"Wing Span b (ft)"},
      area:   {min: 0.5, max: 200, step: 0.1, value: 24, label:"Wing Area S (ft¬≤)"},
      cruise: {min: 10, max: 180, step: 1, value: 55, label:"Cruise Speed (kt)"},
      alt:    {min: 0, max: 25000, step: 100, value: 8000, label:"Altitude (ft)"},
    },
    electric_uav: {
      name: "Electric UAV",
      mtow:   {min: 5, max: 200, step: 0.5, value: 45, label:"MTOW (lb)"},
      span:   {min: 2, max: 60, step: 0.1, value: 20, label:"Wing Span b (ft)"},
      area:   {min: 0.5, max: 200, step: 0.1, value: 26, label:"Wing Area S (ft¬≤)"},
      cruise: {min: 10, max: 160, step: 1, value: 45, label:"Cruise Speed (kt)"},
      alt:    {min: 0, max: 25000, step: 100, value: 6000, label:"Altitude (ft)"},
    },
    hybrid_uav: {
      name: "Hybrid UAV",
      mtow:   {min: 10, max: 350, step: 0.5, value: 120, label:"MTOW (lb)"},
      span:   {min: 4, max: 80, step: 0.1, value: 28, label:"Wing Span b (ft)"},
      area:   {min: 2, max: 260, step: 0.1, value: 46, label:"Wing Area S (ft¬≤)"},
      cruise: {min: 15, max: 220, step: 1, value: 80, label:"Cruise Speed (kt)"},
      alt:    {min: 0, max: 30000, step: 100, value: 12000, label:"Altitude (ft)"},
    },
    commercial: {
      name: "Commercial Plane",
      // keep imperial range so you don't fight backend keys in v1
      mtow:   {min: 20000, max: 220000, step: 500, value: 165000, label:"MTOW (lb)"},
      span:   {min: 30, max: 200, step: 0.1, value: 115, label:"Wing Span b (ft)"},
      area:   {min: 100, max: 3000, step: 1, value: 1345, label:"Wing Area S (ft¬≤)"},
      cruise: {min: 150, max: 520, step: 1, value: 450, label:"Cruise Speed (kt)"},
      alt:    {min: 0, max: 41000, step: 100, value: 35000, label:"Altitude (ft)"},
    }
  };

  function setRange(id, cfg){
    const r = $(id);
    r.min = cfg.min;
    r.max = cfg.max;
    r.step = cfg.step;
  }

  function refreshValueBadges(){
    $("valMTOW").textContent  = `${$("mtow_num").value}`;
    $("valSpan").textContent  = `${$("wing_span_num").value}`;
    $("valArea").textContent  = `${$("wing_area_num").value}`;
    $("valCruise").textContent= `${$("cruise_speed_num").value}`;
    $("valAlt").textContent   = `${$("altitude_num").value}`;

    $("valTaper").textContent = `${$("taper_ratio_num").value}`;
    $("valCLmax").textContent = `${$("cl_max_num").value}`;
    $("valCD0").textContent   = `${$("cd0_num").value}`;
    $("valE").textContent     = `${$("oswald_e_num").value}`;
  }

  function applyPresetToUI(typeKey){
    const p = VEHICLE_PRESETS[typeKey] || VEHICLE_PRESETS.uav;

    $("modelName").textContent = p.name;

    $("lblMTOW").textContent   = p.mtow.label;
    $("lblSpan").textContent   = p.span.label;
    $("lblArea").textContent   = p.area.label;
    $("lblCruise").textContent = p.cruise.label;
    $("lblAlt").textContent    = p.alt.label;

    setRange("mtow", p.mtow);
    setRange("wing_span", p.span);
    setRange("wing_area", p.area);
    setRange("cruise_speed", p.cruise);
    setRange("altitude", p.alt);

    // only set defaults if UI is blank-ish (or on init)
    if(!$("mtow_num").value) {
      $("mtow").value = p.mtow.value; $("mtow_num").value = p.mtow.value;
      $("wing_span").value = p.span.value; $("wing_span_num").value = p.span.value;
      $("wing_area").value = p.area.value; $("wing_area_num").value = p.area.value;
      $("cruise_speed").value = p.cruise.value; $("cruise_speed_num").value = p.cruise.value;
      $("altitude").value = p.alt.value; $("altitude_num").value = p.alt.value;
    }

    refreshValueBadges();
    update3DFromUI();
  }

  // =======================
  // Tabs
  // =======================
  document.querySelectorAll(".tab").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const key = btn.dataset.tab;
      $("tab-basic").style.display = (key==="basic") ? "" : "none";
      $("tab-aero").style.display  = (key==="aero")  ? "" : "none";
      $("tab-perf").style.display  = (key==="perf")  ? "" : "none";
    });
  });

  // =======================
  // Slider sync helpers
  // =======================
  function bindRangePair(rangeId, numId, onChange){
    const r = $(rangeId), n = $(numId);

    r.addEventListener("input", ()=>{
      n.value = r.value;
      refreshValueBadges();
      onChange?.();
    });

    n.addEventListener("input", ()=>{
      const v = parseFloat(n.value);
      if(Number.isFinite(v)){
        const min = parseFloat(r.min), max = parseFloat(r.max);
        const clamped = clamp(v, min, max);
        r.value = clamped;
        n.value = clamped;
        refreshValueBadges();
        onChange?.();
      }
    });
  }

  // =======================
  // Backend calls
  // =======================
  async function apiDefault(typeKey){
    const url = `${DESIGNER_DEFAULT}?type=${encodeURIComponent(typeKey || "uav")}`;
    const r = await fetch(url, { cache: "no-store" });
    if(!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  async function apiCompute(stateObj){
    const r = await fetch(DESIGNER_COMPUTE, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ state: stateObj })
    });
    if(!r.ok) throw new Error(await r.text());
    return await r.json();
  }

  async function apiExport(stateObj){
    const r = await fetch(DESIGNER_EXPORT, {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ state: stateObj })
    });
    if(!r.ok) throw new Error(await r.text());
    return await r.blob();
  }

  // =======================
  // UI <-> State sync
  // =======================
  function hydrateUIFromState(){
    if(!state) return;

    const typeKey = state.meta?.vehicle_type || $("vehicleType").value || "uav";
    $("vehicleType").value = typeKey;
    applyPresetToUI(typeKey);

    // Pull from state, clamp to slider ranges, write into UI
    const mtow  = state.inputs?.mass?.mtow_lb?.value ?? 0;
    const span  = state.inputs?.geometry?.wing_span_ft?.value ?? 0;
    const area  = state.inputs?.geometry?.wing_area_ft2?.value ?? 0;

    const taper = state.inputs?.geometry?.taper_ratio?.value ?? 0.55;
    const clmax = state.inputs?.aero?.cl_max?.value ?? 1.6;
    const cd0   = state.inputs?.aero?.cd0?.value ?? 0.03;
    const e     = state.inputs?.aero?.oswald_e?.value ?? 0.80;

    const cruise= state.inputs?.mission?.cruise_speed_kt?.value ?? 55;
    const alt   = state.inputs?.environment?.altitude_ft?.value ?? state.inputs?.mission?.cruise_altitude_ft?.value ?? 8000;

    function setPair(rangeId, numId, v){
      const r = $(rangeId), n = $(numId);
      const min = parseFloat(r.min), max = parseFloat(r.max);
      const vv = clamp(Number(v) || 0, min, max);
      r.value = vv;
      n.value = vv;
    }

    setPair("mtow", "mtow_num", mtow);
    setPair("wing_span", "wing_span_num", span);
    setPair("wing_area", "wing_area_num", area);
    setPair("cruise_speed", "cruise_speed_num", cruise);
    setPair("altitude", "altitude_num", alt);

    // Aero fields
    $("taper_ratio").value = taper; $("taper_ratio_num").value = taper;
    $("cl_max").value = clmax;      $("cl_max_num").value = clmax;
    $("cd0").value = cd0;           $("cd0_num").value = cd0;
    $("oswald_e").value = e;        $("oswald_e_num").value = e;

    refreshValueBadges();
  }

  function syncUIToState(){
    if(!state) return;

    const typeKey = $("vehicleType").value || "uav";
    state.meta.vehicle_type = typeKey;
    state.meta.name = VEHICLE_PRESETS[typeKey]?.name || state.meta.name;

    // --- Read UI values ---
    const mtow  = parseFloat($("mtow_num").value);
    const span  = parseFloat($("wing_span_num").value);
    const area  = parseFloat($("wing_area_num").value);

    const taper = parseFloat($("taper_ratio_num").value);
    const clmax = parseFloat($("cl_max_num").value);
    const cd0   = parseFloat($("cd0_num").value);
    const e     = parseFloat($("oswald_e_num").value);

    const cruise= parseFloat($("cruise_speed_num").value);
    const alt   = parseFloat($("altitude_num").value);

    // Guard nested structure (in case)
    ensure(state, "inputs", {});
    ensure(state.inputs, "mass", {});
    ensure(state.inputs, "geometry", {});
    ensure(state.inputs, "aero", {});
    ensure(state.inputs, "mission", {});
    ensure(state.inputs, "environment", {});

    // Scalars exist
    state.inputs.mass.mtow_lb = setScalar(state.inputs.mass.mtow_lb, mtow, "lb");
    state.inputs.geometry.wing_span_ft = setScalar(state.inputs.geometry.wing_span_ft, span, "ft");
    state.inputs.geometry.wing_area_ft2 = setScalar(state.inputs.geometry.wing_area_ft2, area, "ft^2");
    state.inputs.geometry.taper_ratio = setScalar(state.inputs.geometry.taper_ratio, taper, "none");

    state.inputs.aero.cl_max = setScalar(state.inputs.aero.cl_max, clmax, "none");
    state.inputs.aero.cd0 = setScalar(state.inputs.aero.cd0, cd0, "none");
    state.inputs.aero.oswald_e = setScalar(state.inputs.aero.oswald_e, e, "none");

    state.inputs.mission.cruise_speed_kt = setScalar(state.inputs.mission.cruise_speed_kt, cruise, "kt");
    state.inputs.mission.cruise_altitude_ft = setScalar(state.inputs.mission.cruise_altitude_ft, alt, "ft");
    state.inputs.environment.altitude_ft = setScalar(state.inputs.environment.altitude_ft, alt, "ft");
  }

  // =======================
  // Results rendering
  // =======================
  function renderResults(){
    const ar  = state?.computed?.geometry?.aspect_ratio?.value;
    const mac = state?.computed?.geometry?.mac_ft?.value;

    $("miniAR").textContent  = `AR: ${num(ar,2)}`;
    $("miniMAC").textContent = `MAC: ${num(mac,2)}`;

    const ld = state?.results?.aero?.lift_drag;
    const stall = state?.results?.performance?.stall;
    const end = state?.results?.performance?.endurance;

    $("outCL").textContent = ld ? num(ld.cl.value, 3) : "‚Äî";
    $("outD").textContent  = ld ? `${num(ld.drag_lbf.value, 2)} lbf` : "‚Äî";
    $("outLD").textContent = ld ? num(ld.ld.value, 2) : "‚Äî";
    $("outVstall").textContent = stall ? `${num(stall.v_stall_kt.value, 1)} kt` : "‚Äî";

    const p = end ? num(end.power_required_hp.value, 2) : "‚Äî";
    const e = end ? num(end.endurance_hr.value, 2) : "‚Äî";
    const r = end ? num(end.range_nmi_at_cruise.value, 1) : "‚Äî";
    $("outP").textContent = end ? `${p} hp` : "‚Äî";
    $("outER").textContent = end ? `${e} hr ‚Ä¢ ${r} nmi` : "‚Äî";

    const warnList = $("warnList");
    warnList.innerHTML = "";
    const warnings = (ld && ld.warnings) ? ld.warnings : [];
    if (!warnings.length){
      warnList.innerHTML = `
        <div class="warnItem">
          <span class="dot good"></span>
          <div class="warnText">All good ‚Äî no warnings at current conditions.</div>
        </div>`;
    } else {
      warnings.forEach(w=>{
        const d = document.createElement("div");
        d.className = "warnItem";
        d.innerHTML = `<span class="dot"></span><div class="warnText">${w}</div>`;
        warnList.appendChild(d);
      });
    }
  }

  async function runCompute(){
    try{
      setPill($("statusPill"), "Computing‚Ä¶", "warn");

      if(!state){
        state = await apiDefault($("vehicleType").value || "uav");
      }

      syncUIToState();
      state = await apiCompute(state);

      // reflect computed updates + keep UI clean
      hydrateUIFromState();
      renderResults();
      update3DFromState();

      setPill($("statusPill"), "Live", "good");
    }catch(e){
      console.error(e);
      setPill($("statusPill"), "Error", "bad");
    }
  }

  function scheduleCompute(){
    clearTimeout(computeTimer);
    computeTimer = setTimeout(runCompute, 280);
  }

  // =======================
  // Three.js renderer
  // =======================
  let scene, camera, renderer, controls;
  let fuselageMesh, wingMesh, tailMesh, vtailMesh, grid;
  let threeInited = false;

  function initThree(){
    const canvas = $("threeCanvas");
    renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));

    scene = new THREE.Scene();

    camera = new THREE.PerspectiveCamera(45, 1, 0.1, 2000);
    camera.position.set(18, 10, 18);

    controls = new THREE.OrbitControls(camera, canvas);
    controls.enableDamping = true;
    controls.dampingFactor = 0.06;
    controls.target.set(0, 1.5, 0);

    const key = new THREE.DirectionalLight(0xffffff, 1.0);
    key.position.set(15, 20, 10);
    scene.add(key);

    const fill = new THREE.DirectionalLight(0xffffff, 0.45);
    fill.position.set(-15, 12, -10);
    scene.add(fill);

    const amb = new THREE.AmbientLight(0xffffff, 0.35);
    scene.add(amb);

    grid = new THREE.GridHelper(80, 40, 0x3b82f6, 0x1f2a44);
    grid.position.y = 0;
    grid.material.opacity = 0.25;
    grid.material.transparent = true;
    scene.add(grid);

    const mat = new THREE.MeshStandardMaterial({
      color: 0x60a5fa,
      metalness: 0.15,
      roughness: 0.55
    });

    fuselageMesh = new THREE.Mesh(new THREE.BoxGeometry(8, 1.3, 1.3), mat);
    fuselageMesh.position.set(0, 1.3, 0);
    scene.add(fuselageMesh);

    wingMesh = new THREE.Mesh(new THREE.BoxGeometry(10, 0.22, 2.2), mat);
    wingMesh.position.set(0, 1.2, 0);
    scene.add(wingMesh);

    tailMesh = new THREE.Mesh(new THREE.BoxGeometry(3.2, 0.18, 1.1), mat);
    tailMesh.position.set(-3.2, 1.7, 0);
    scene.add(tailMesh);

    vtailMesh = new THREE.Mesh(new THREE.BoxGeometry(0.2, 1.4, 0.9), mat);
    vtailMesh.position.set(-3.8, 2.1, 0);
    scene.add(vtailMesh);

    function resize(){
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(1, Math.floor(rect.width));
      const h = Math.max(1, Math.floor(rect.height));
      renderer.setSize(w, h, false);
      camera.aspect = w / h;
      camera.updateProjectionMatrix();
    }
    window.addEventListener("resize", resize);
    resize();

    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    threeInited = true;
  }

  function updateMeshes(span, area, typeKey){
    if(!threeInited) return;

    const cAvg = Math.max(0.6, area / Math.max(span, 0.1));
    const thickness = Math.max(0.12, 0.06 * cAvg);

    let fusL = Math.max(6, 0.65 * span);
    if(typeKey === "commercial") fusL = Math.max(30, 0.75 * span);
    fusL = fusL * 0.55;
    const fusD = Math.max(0.9, 0.10 * fusL);

    const hTailSpan = Math.max(1.5, 0.28 * span);
    const hTailChord = Math.max(0.7, 0.35 * cAvg);
    const vTailH = Math.max(1.0, 0.55 * hTailSpan);

    const scale = Math.max(0.6, Math.min(2.0, span / 20.0));
    const s = 0.9 / scale;

    fuselageMesh.geometry.dispose();
    fuselageMesh.geometry = new THREE.BoxGeometry(fusL * s, fusD * s, fusD * s);
    fuselageMesh.position.set(0, (1.2 + 0.6 * fusD) * s, 0);

    wingMesh.geometry.dispose();
    wingMesh.geometry = new THREE.BoxGeometry(span * s, thickness * s, cAvg * s);
    wingMesh.position.set(0, (1.1 + 0.55 * fusD) * s, 0);

    tailMesh.geometry.dispose();
    tailMesh.geometry = new THREE.BoxGeometry(hTailSpan * s, (0.8*thickness) * s, hTailChord * s);
    tailMesh.position.set((-0.45 * fusL) * s, (1.35 + 0.75 * fusD) * s, 0);

    vtailMesh.geometry.dispose();
    vtailMesh.geometry = new THREE.BoxGeometry((0.10*hTailChord) * s, vTailH * s, (0.70*hTailChord) * s);
    vtailMesh.position.set((-0.48 * fusL) * s, (1.55 + 0.75 * fusD) * s + (0.5*vTailH*s), 0);

    // display quick UI-based AR/MAC for immediate feedback
    const AR = (span*span) / Math.max(area, 0.01);
    $("miniAR").textContent = `AR: ${num(AR,2)}`;
    $("miniMAC").textContent = `MAC: ${num(cAvg,2)}`;
  }

  function update3DFromUI(){
    const typeKey = $("vehicleType").value || "uav";
    const span = parseFloat($("wing_span_num").value) || (VEHICLE_PRESETS[typeKey]?.span.value ?? 18);
    const area = parseFloat($("wing_area_num").value) || (VEHICLE_PRESETS[typeKey]?.area.value ?? 24);
    updateMeshes(span, area, typeKey);
  }

  function update3DFromState(){
    if(!state) return;
    const typeKey = state.meta?.vehicle_type || $("vehicleType").value || "uav";
    const span = state.inputs?.geometry?.wing_span_ft?.value ?? 18;
    const area = state.inputs?.geometry?.wing_area_ft2?.value ?? 24;
    updateMeshes(span, area, typeKey);

    // if backend computed AR/MAC exists, show it
    const ar  = state?.computed?.geometry?.aspect_ratio?.value;
    const mac = state?.computed?.geometry?.mac_ft?.value;
    if(ar !== undefined && ar !== null) $("miniAR").textContent  = `AR: ${num(ar,2)}`;
    if(mac !== undefined && mac !== null) $("miniMAC").textContent = `MAC: ${num(mac,2)}`;
  }

  // =======================
  // Wiring
  // =======================
  bindRangePair("mtow", "mtow_num", ()=>{ scheduleCompute(); });
  bindRangePair("wing_span", "wing_span_num", ()=>{ update3DFromUI(); scheduleCompute(); });
  bindRangePair("wing_area", "wing_area_num", ()=>{ update3DFromUI(); scheduleCompute(); });
  bindRangePair("taper_ratio", "taper_ratio_num", ()=>{ scheduleCompute(); });
  bindRangePair("cl_max", "cl_max_num", ()=>{ scheduleCompute(); });
  bindRangePair("cd0", "cd0_num", ()=>{ scheduleCompute(); });
  bindRangePair("oswald_e", "oswald_e_num", ()=>{ scheduleCompute(); });
  bindRangePair("cruise_speed", "cruise_speed_num", ()=>{ scheduleCompute(); });
  bindRangePair("altitude", "altitude_num", ()=>{ scheduleCompute(); });

  $("vehicleType").addEventListener("change", async ()=>{
    const typeKey = $("vehicleType").value;

    try{
      setPill($("statusPill"), "Loading‚Ä¶", "warn");
      state = await apiDefault(typeKey);
      hydrateUIFromState();
      renderResults();
      update3DFromState();
      setPill($("statusPill"), "Live", "good");
    }catch(e){
      console.error(e);
      setPill($("statusPill"), "Offline", "bad");
    }
  });

  $("btnCompute").addEventListener("click", runCompute);

  $("btnSoftReset").addEventListener("click", async ()=>{
    try{
      setPill($("statusPill"), "Resetting‚Ä¶", "warn");
      state = await apiDefault($("vehicleType").value || "uav");
      hydrateUIFromState();
      renderResults();
      update3DFromState();
      setPill($("statusPill"), "Live", "good");
    }catch(e){
      console.error(e);
      setPill($("statusPill"), "Offline", "bad");
    }
  });

  $("btnReset").addEventListener("click", async ()=>{
    try{
      setPill($("statusPill"), "Resetting‚Ä¶", "warn");
      state = await apiDefault($("vehicleType").value || "uav");
      hydrateUIFromState();
      renderResults();
      update3DFromState();
      setPill($("statusPill"), "Live", "good");
    }catch(e){
      console.error(e);
      setPill($("statusPill"), "Offline", "bad");
    }
  });

  $("btnExport").addEventListener("click", async ()=>{
    try{
      setPill($("statusPill"), "Exporting‚Ä¶", "warn");

      if(!state) state = await apiDefault($("vehicleType").value || "uav");
      syncUIToState();

      const blob = await apiExport(state);
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `ISA_Designer_${$("vehicleType").value}.xlsx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      setPill($("statusPill"), "Live", "good");
    }catch(e){
      console.error(e);
      setPill($("statusPill"), "Export Error", "bad");
    }
  });

  $("btnCad").addEventListener("click", ()=>{
    alert("CAD Rendering is in Beta. Next step: connect to /api/designer/cad to generate renders.");
  });

  // =======================
  // Init
  // =======================
  (async function init(){
    initThree();

    // Seed aero defaults so fields aren't blank before first hydrate
    $("taper_ratio").value = 0.55; $("taper_ratio_num").value = 0.55;
    $("cl_max").value = 1.6;       $("cl_max_num").value = 1.6;
    $("cd0").value = 0.03;         $("cd0_num").value = 0.03;
    $("oswald_e").value = 0.80;    $("oswald_e_num").value = 0.80;

    applyPresetToUI("uav");
    update3DFromUI();

    try{
      setPill($("statusPill"), "Loading‚Ä¶", "warn");
      state = await apiDefault("uav");
      hydrateUIFromState();
      renderResults();
      update3DFromState();
      setPill($("statusPill"), "Live", "good");
    }catch(e){
      console.error(e);
      setPill($("statusPill"), "Offline", "bad");
    }
  })();
</script>

</body>
</html>
